<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áŸáŸ’áœáŸ‚á„ášá€á“á·áŸáŸ’áŸá·á Firebase</title>
    <!-- 1. á”á“áŸ’ááŸ‚á˜ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. á”á“áŸ’ááŸ‚á˜ Firebase SDKs (Realtime Database) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- 3. á”á“áŸ’ááŸ‚á˜ Lucide (áŸá˜áŸ’ášá¶á”áŸ‹ Icons) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* á”á“áŸ’ááŸ‚á˜á–á»á˜áŸ’á–á¢á€áŸ’áŸášááŸ’á˜áŸ‚áš */
        @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', 'Kantumruy Pro', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* áŸá˜áŸ’ášá¶á”áŸ‹á›á¶á€áŸ‹ scrollbar ááŸ‚á“áŸ…ááŸ‚á¢á¶á… scroll á”á¶á“ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* á€áŸ†áááŸ‹á‘áŸ†á áŸ† Icon á“áŸ…á€áŸ’á“á»á„ Card */
        .detail-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0; 
        }
        
        /* áŸá˜áŸ’ášá¶á”áŸ‹ Icon á€áŸ’á“á»á„á”áŸ’ášá¢á”áŸ‹ Search */
        .search-icon {
            position: absolute;
            left: 0.75rem; /* 12px */
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF; /* text-gray-400 */
        }
        
        .search-input {
            padding-left: 2.5rem; /* 40px */
        }

        /* á€áŸ†áááŸ‹á€á˜áŸ’á–áŸáŸ‹ Header ááŸáš (áŸá˜áŸ’ášá¶á”áŸ‹á‚áá“á¶ sticky top) */
        .header-height {
            height: 72px; 
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- á€áŸ’ášá”ááŸááŸ’áŒá–áŸá‰á¢áŸá€áŸ’ášá„áŸ‹ (Full-screen Frame) -->
    <div class="w-full h-screen flex flex-col">
        
        <!-- Header (Sticky) -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-5 shadow-md z-20 sticky top-0 flex items-center justify-center header-height">
            <h1 class="text-2xl font-bold text-white text-center">
                ğŸ“¦ áŸáŸ’áœáŸ‚á„ášá€á“á·áŸáŸ’áŸá·á
            </h1>
        </div>

        <!-- á•áŸ’á‘áŸƒ Scrollable Content -->
        <!-- á”áŸ’ášá¾ `calc` áŠá¾á˜áŸ’á”á¸áŠá€á€á˜áŸ’á–áŸáŸ‹ Header á…áŸá‰á–á¸á€á˜áŸ’á–áŸáŸ‹á¢áŸá€áŸ’ášá„áŸ‹ -->
        <div class="flex-1 flex flex-col overflow-hidden" style="height: calc(100vh - 72px);">
            
            <!-- á•áŸ’á“áŸ‚á€áŸáŸ’áœáŸ‚á„ášá€ (Sticky) -->
            <!-- á“áŸáŸ‡á“á¹á„á“áŸ…áá¶á„á›á¾ á á¾á™á•áŸ’á“áŸ‚á€á›á‘áŸ’á’á•á›á“á¹á„ scroll á“áŸ…áá¶á„á€áŸ’ášáŸ„á˜áœá¶ -->
            <div class="p-5 bg-white shadow-md z-10 sticky top-[72px]">
                <label for="search-all" class="text-lg font-semibold text-gray-800 mb-3 block">
                    áŸáŸ’áœáŸ‚á„ášá€á“á·áŸáŸ’áŸá·á
                </label>
                <div class="relative">
                    <i data-lucide="search" class="search-icon w-5 h-5"></i>
                    <input 
                        type="text" 
                        id="search-all"
                        placeholder="áœá¶á™ áˆáŸ’á˜áŸ„áŸ‡, ID, á€áŸ’ášá»á˜, ááŸ’á“á¶á€áŸ‹, á¬á•áŸ’á“áŸ‚á€á€á¶ášá„á¶áš..."
                        class="search-input w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                </div>
                <!-- Status Message Area -->
                <div id="status-message" class="p-3 mt-4 rounded-md bg-blue-100 text-blue-800 text-sm">â³ á€áŸ†á–á»á„á‘á¶á‰á”á‰áŸ’á‡á¸á“á·áŸáŸ’áŸá·á...</div>
            </div>

            <!-- Output Section (Scrollable) -->
            <div class="flex-1 overflow-y-auto no-scrollbar p-5">
                <label class="text-lg font-semibold text-gray-800 mb-3 block">
                    á›á‘áŸ’á’á•á›áŸáŸ’áœáŸ‚á„ášá€
                </label>
                <!-- á€á“áŸ’á›áŸ‚á„á”á„áŸ’á á¶á‰ Card -->
                <div id="card-output-area" class="space-y-4">
                    <!-- Cards á“á¹á„ááŸ’ášá¼áœá”á¶á“á”á‰áŸ’á…á¼á›á˜á€á‘á¸á“áŸáŸ‡áŠáŸ„á™ JavaScript -->
                    <p id="initial-message" class="text-gray-500 text-center p-4">
                        áŸá¼á˜áœá¶á™á€áŸ’á“á»á„á”áŸ’ášá¢á”áŸ‹áŸáŸ’áœáŸ‚á„ášá€ áŠá¾á˜áŸ’á”á¸á”á„áŸ’á á¶á‰á‘á·á“áŸ’á“á“áŸá™...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // áŸ¡. âš¡ï¸âš¡ï¸âš¡ï¸ á˜á»áá„á¶áš Debounce (áŸá˜áŸ’ášá¶á”áŸ‹á”á„áŸ’á€á¾á“á›áŸ’á”á¿á“áŸáŸ’áœáŸ‚á„ášá€) âš¡ï¸âš¡ï¸âš¡ï¸
        // ------------------------------------------------------------------
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ------------------------------------------------------------------
        // áŸ¢. âš¡ï¸âš¡ï¸âš¡ï¸ á€á¶ášá€áŸ†áááŸ‹ášá…á“á¶áŸá˜áŸ’á–áŸá“áŸ’á’ Firebase âš¡ï¸âš¡ï¸âš¡ï¸
        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAc2g-t9A7du3K_nI2fJnw_OGxhmLfpP6s",
            authDomain: "dilistname.firebaseapp.com",
            databaseURL: "https://dilistname-default-rtdb.firebaseio.com",
            projectId: "dilistname",
            storageBucket: "dilistname.firebasestorage.app",
            messagingSenderId: "897983357871",
            appId: "1:897983357871:web:42a046bc9fb3e0543dc55a"
        };
        
        // áŸ£. á’á¶áá» (Elements) áŸá˜áŸ’ášá¶á”áŸ‹á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„
        const statusEl = document.getElementById('status-message');
        const outputEl = document.getElementById('card-output-area');
        const initialMessageEl = document.getElementById('initial-message');
        const searchAllEl = document.getElementById('search-all');

        // áŸ¤. á•áŸ’áá½á…á•áŸ’áá¾á˜ (Initialize) Firebase
        let firebaseApp;
        let database;
        let allStudentsData = []; // á¢ááŸášáŸá˜áŸ’ášá¶á”áŸ‹á•áŸ’á‘á»á€á‘á·á“áŸ’á“á“áŸá™á‘á¶áŸ†á„á¢áŸáŸ‹
        
        try {
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            } else {
                firebaseApp = firebase.app();
                database = firebase.database();
            }
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showStatus(`á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá—áŸ’á‡á¶á”áŸ‹ FirebaseáŸ– ${error.message} áŸá¼á˜á–á·á“á·ááŸ’á™ Config ášá”áŸáŸ‹á¢áŸ’á“á€áŸ”`, 'error');
        }
        
        function showStatus(message, type = 'loading') {
            if (!statusEl) return;
            statusEl.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            
            if (type === 'loading') {
                statusEl.classList.add('bg-blue-100', 'text-blue-800');
                statusEl.textContent = `â³ ${message}`;
            } else if (type === 'error') {
                statusEl.classList.add('bg-red-100', 'text-red-800');
                statusEl.textContent = `âŒ ${message}`;
            } else if (type === 'success') {
                statusEl.classList.add('bg-green-100', 'text-green-800');
                statusEl.textContent = `âœ… ${message}`;
            }
            
            statusEl.classList.remove('hidden');
        }

        // áŸ¥. á˜á»áá„á¶ášáŸá˜áŸ’ášá¶á”áŸ‹á”á„áŸ’á€á¾á Card
        
        function createDetailRow(icon, label, value) {
            if (!value || String(value).trim() === '') {
                return '';
            }
            return `
                <div class="flex items-start space-x-3 text-sm text-gray-700">
                    <i data-lucide="${icon}" class="detail-icon text-indigo-600 mt-1"></i>
                    <div class="flex-1 break-words">
                        <span class="font-medium">${label}:</span>
                        <span class="text-gray-900">${value}</span>
                    </div>
                </div>
            `;
        }

        function createStudentCard(student) {
            // á‘á¶á‰á™á€ Fields áá¶á˜á”á‰áŸ’á‡á¸áŠáŸ‚á›á¢áŸ’á“á€á”á¶á“á”á‰áŸ’á‡á¶á€áŸ‹
            const name = student.áˆáŸ’á˜áŸ„áŸ‡ || 'á˜á·á“á˜á¶á“áˆáŸ’á˜áŸ„áŸ‡';
            const studentId = student.á¢ááŸ’áá›áŸá || 'N/A';
            const group = student.á€áŸ’ášá»á˜ || 'N/A';
            const gender = student.á—áŸá‘ || 'N/A';
            const className = student.ááŸ’á“á¶á€áŸ‹ || 'N/A';
            const major = student.á•áŸ’á“áŸ‚á€á€á¶ášá„á¶áš || 'á˜á·á“á”á¶á“á”á‰áŸ’á‡á¶á€áŸ‹';
            const role = student.áá½á“á¶á‘á¸ || 'N/A';
            const link = student.ááŸá¡áŸá€áŸ’ášá¶á˜ || '';
            const imageUrl = student.ášá¼á”áá || '';
            const gen = student.á‡áŸ†á“á¶á“áŸ‹ || 'N/A';
            const year = student.á†áŸ’á“á¶áŸ†áŸá·á€áŸ’áŸá¶ || 'N/A';
            
            const placeholderImg = `https://placehold.co/200x200/e2e8f0/94a3b8?text=${encodeURIComponent(name.charAt(0) || '?')}`;

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden transition-all hover:shadow-xl">
                    <div class="p-5">
                        <div class="flex justify-center mb-4">
                            <img 
                                src="${imageUrl}" 
                                alt="ášá¼á”ááášá”áŸáŸ‹ ${name}" 
                                class="w-24 h-24 object-cover rounded-full border-4 border-indigo-100 shadow-lg"
                                onerror="this.onerror=null; this.src='${placeholderImg}';"
                            >
                        </div>
                        <h3 class="text-2xl font-bold text-indigo-700 break-words text-center">${name}</h3>
                        <p class="text-md font-medium text-gray-600 mb-4 text-center">ID: ${studentId}</p>
                        
                        <div class="space-y-3">
                            ${createDetailRow('briefcase', 'á•áŸ’á“áŸ‚á€á€á¶ášá„á¶áš', major)}
                            ${createDetailRow('award', 'áá½á“á¶á‘á¸', role)}
                            ${createDetailRow('layers', 'á‡áŸ†á“á¶á“áŸ‹', gen)}
                            ${createDetailRow('calendar-days', 'á†áŸ’á“á¶áŸ†áŸá·á€áŸ’áŸá¶', year)}
                            ${createDetailRow('bookmark', 'ááŸ’á“á¶á€áŸ‹', className)}
                            ${createDetailRow('users', 'á€áŸ’ášá»á˜', group)}
                            ${createDetailRow('user-check', 'á—áŸá‘', gender)}
                        </div>
                    </div>
                    ${link !== '' ? `
                    <div class="p-5 border-t border-gray-100 bg-gray-50">
                        <a 
                            href="${link}" 
                            target="_blank" 
                            class="flex items-center justify-center w-full text-center bg-indigo-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors"
                        >
                            <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                            á˜á¾á›ááŸ†áá—áŸ’á‡á¶á”áŸ‹ (Telegram)
                        </a>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // áŸ¦. á˜á»áá„á¶ášáŸ– ááŸ’ášá„ (Filter) á“á·á„ á”á„áŸ’á á¶á‰ (Render) á›á‘áŸ’á’á•á›
        function renderFilteredResults() {
            if (!searchAllEl || !outputEl || !initialMessageEl) return;
            
            const searchTerm = searchAllEl.value.toLowerCase().trim();

            // âš¡ï¸âš¡ï¸âš¡ï¸ FIX (Optimize Rendering): 
            // áŸ¡. á”á„áŸ’á€á¾á HTML á‘á¶áŸ†á„á¢áŸáŸ‹á€áŸ’á“á»á„ String ááŸ‚á˜á½á™
            let resultsHTML = '';

            // á”áŸ’ášáŸá·á“á”á¾á”áŸ’ášá¢á”áŸ‹ search á‘á‘áŸ
            if (!searchTerm) {
                initialMessageEl.style.display = 'block';
                outputEl.innerHTML = ''; // áŸá˜áŸ’á¢á¶áá›á‘áŸ’á’á•á›
                return;
            }

            initialMessageEl.style.display = 'none';

            const filtered = allStudentsData.filter(student => {
                const name = String(student.áˆáŸ’á˜áŸ„áŸ‡ || '').toLowerCase();
                const id = String(student.á¢ááŸ’áá›áŸá || '').toLowerCase();
                const group = String(student.á€áŸ’ášá»á˜ || '').toLowerCase();
                const className = String(student.ááŸ’á“á¶á€áŸ‹ || '').toLowerCase();
                const major = String(student.á•áŸ’á“áŸ‚á€á€á¶ášá„á¶áš || '').toLowerCase(); 

                return name.includes(searchTerm) || 
                       id.includes(searchTerm) || 
                       group.includes(searchTerm) || 
                       className.includes(searchTerm) ||
                       major.includes(searchTerm); 
            });

            if (filtered.length === 0) {
                resultsHTML = '<p class="text-gray-500 text-center p-4">á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™ááŸ’ášá¼áœá‚áŸ’á“á¶á“á¹á„á€á¶ášáŸáŸ’áœáŸ‚á„ášá€á‘áŸáŸ”</p>';
            } else {
                filtered.forEach(student => {
                    // áŸ¢. á”á¼á€ String á”á‰áŸ’á…á¼á›á‚áŸ’á“á¶ (á›á¿á“á‡á¶á„ .innerHTML +=)
                    resultsHTML += createStudentCard(student);
                });
            }
            
            // áŸ£. "á‚á¼áš" (Render) á‘áŸ… DOM ááŸ‚á˜áŸ’áŠá„á‚ááŸ‹
            outputEl.innerHTML = resultsHTML;

            // áŸ¤. á áŸ… Lucide á”á“áŸ’á‘á¶á”áŸ‹á–á¸ HTML ááŸ’ášá¼áœá”á¶á“á”á‰áŸ’á…á¼á›
            lucide.createIcons();
        }

        // áŸ§. á˜á»áá„á¶ášá‘á¶á‰á‘á·á“áŸ’á“á“áŸá™
        function fetchFirebaseData() {
            if (!database) {
                showStatus('Firebase á˜á·á“á‘á¶á“áŸ‹á—áŸ’á‡á¶á”áŸ‹ášá½á…ášá¶á›áŸ‹á‘áŸáŸ”', 'error');
                return;
            }

            const path = "/students"; 
            showStatus(`á€áŸ†á–á»á„á—áŸ’á‡á¶á”áŸ‹á‘áŸ…á€á¶á“áŸ‹ Path: ${path}`, 'loading');

            try {
                const dbRef = database.ref(path);
                
                dbRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        if (typeof data === 'object' && data !== null) {
                            allStudentsData = Object.values(data);
                            showStatus(`á”á¶á“á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™ ${allStudentsData.length} á“á¶á€áŸ‹áŸ” áŸá¼á˜á…á¶á”áŸ‹á•áŸ’áá¾á˜áŸáŸ’áœáŸ‚á„ášá€áŸ”`, 'success');
                            renderFilteredResults(); // á’áŸ’áœá¾á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–á›á‘áŸ’á’á•á› (á€áŸ’á“á»á„á€ášáá¸á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á”á¶á“áœá¶á™á¢áŸ’áœá¸á˜á½á™ášá½á…á á¾á™)
                        } else {
                            allStudentsData = [];
                            showStatus('á‘á·á“áŸ’á“á“áŸá™á˜á¶á“ á”áŸ‰á»á“áŸ’ááŸ‚á˜á·á“á˜áŸ‚á“á‡á¶ Object', 'error');
                        }
                    } else {
                        allStudentsData = [];
                        showStatus(`á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™ááŸ’ášá¼áœá”á¶á“ášá€áƒá¾á‰á“áŸ… "${path}"`, 'error');
                    }
                }, (error) => {
                    console.error("Firebase fetch error:", error);
                    showStatus(`á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá‘á¶á‰á‘á·á“áŸ’á“á“áŸá™áŸ– ${error.message}`, 'error');
                });
                
            } catch (error) {
                console.error("Error setting up listener:", error);
                showStatus(`á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášáá—áŸ’á‡á¶á”áŸ‹áŸ– ${error.message}`, 'error');
            }
        }

        // áŸ¨. á…á¶á”áŸ‹á•áŸ’áá¾á˜á€á˜áŸ’á˜áœá·á’á¸
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            if (searchAllEl) {
                // âš¡ï¸âš¡ï¸âš¡ï¸ FIX (Debounce): á”áŸ’ášá¾ debounce 300ms áŠá¾á˜áŸ’á”á¸á€á»áŸ†á±áŸ’á™á‚á¶áŸ†á„
                searchAllEl.addEventListener('input', debounce(renderFilteredResults, 300));
            }

            fetchFirebaseData();
        });
    </script>

</body>
</html>

